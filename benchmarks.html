<!DOCTYPE html>
<head>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">

  <title>Falx Benchmarks</title>

  <!-- Bootstrap CSS CDN -->
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.0/css/bootstrap.min.css" integrity="sha384-9gVQ4dYFwwWSjIDZnLEWnxCjeSWFphJiwGPXr1jddIhOegiu1FwO5qRGvFXOdJZ4" crossorigin="anonymous">

  <!-- Our Custom CSS -->
  <link rel="stylesheet" href="static/benchmarks.css">

  <!-- Font Awesome JS -->
  <script defer src="https://use.fontawesome.com/releases/v5.0.13/js/solid.js" integrity="sha384-tzzSw1/Vo+0N5UhStP3bvwWPq+uvzCMfrN1fEFe+xBmv1C/AtVX5K0uZtmcHitFZ" crossorigin="anonymous"></script>
  <script defer src="https://use.fontawesome.com/releases/v5.0.13/js/fontawesome.js" integrity="sha384-6OIrr52G08NpOFSZdxxz1xdNSndlD4vdcf/q2myIUVO0VsqaGHJsB0RaBE01VTOY" crossorigin="anonymous"></script>

  <script src="https://cdn.jsdelivr.net/npm/vega@5"></script>
	<script src="https://cdn.jsdelivr.net/npm/vega-lite@4.0.0-beta.2"></script>
	<script src="https://cdn.jsdelivr.net/npm/vega-embed@5"></script>

   <!-- jQuery CDN - Slim version (=without AJAX) -->
  <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
  <!-- Popper.JS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.0/umd/popper.min.js" integrity="sha384-cs/chFZiN24E4KMATLdqdvsezGxaGsi4hLGOzlXwp5UZB1LY//20VyM2taTB4QvJ" crossorigin="anonymous"></script>
  <!-- Bootstrap JS -->
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.0/js/bootstrap.min.js" integrity="sha384-uefMccjFJAIv6A+rW+L4AHf99KvxDjWSu1z9VI8SKNVmz4sk7buKt/6v9KI65qnm" crossorigin="anonymous"></script>
  
  <!-- Bootstrap Table -->
  <link rel="stylesheet" href="https://unpkg.com/bootstrap-table@1.15.5/dist/bootstrap-table.min.css">
  <script src="https://unpkg.com/bootstrap-table@1.15.5/dist/bootstrap-table.min.js"></script>

  <script src="static/benchmarks.js"></script>

</head>

<body>  

  <div class="wrapper">

    <!-- Sidebar -->
    <nav id="sidebar">
      <ul>
        <li> <a href="#" onclick="renderHome()">Home</a></li>
        <li> <a href="#" onclick="renderBenchmark('001')">001</a></li>
        <li> <a href="#" onclick="renderBenchmark('002')">002</a></li>
        <li> <a href="#" onclick="renderBenchmark('003')">003</a></li>
        <li> <a href="#" onclick="renderBenchmark('004')">004</a></li>
        <li> <a href="#" onclick="renderBenchmark('005')">005</a></li>
        <li> <a href="#" onclick="renderBenchmark('006')">006</a></li>
        <li> <a href="#" onclick="renderBenchmark('007')">007</a></li>
        <li> <a href="#" onclick="renderBenchmark('008')">008</a></li>
        <li> <a href="#" onclick="renderBenchmark('009')">009</a></li>
        <li> <a href="#" onclick="renderBenchmark('010')">010</a></li>
        <li> <a href="#" onclick="renderBenchmark('011')">011</a></li>
        <li> <a href="#" onclick="renderBenchmark('012')">012</a></li>
        <li> <a href="#" onclick="renderBenchmark('013')">013</a></li>
        <li> <a href="#" onclick="renderBenchmark('014')">014</a></li>
        <li> <a href="#" onclick="renderBenchmark('015')">015</a></li>
        <li> <a href="#" onclick="renderBenchmark('016')">016</a></li>
        <li> <a href="#" onclick="renderBenchmark('017')">017</a></li>
        <li> <a href="#" onclick="renderBenchmark('018')">018</a></li>
        <li> <a href="#" onclick="renderBenchmark('019')">019</a></li>
        <li> <a href="#" onclick="renderBenchmark('020')">020</a></li>
        <li> <a href="#" onclick="renderBenchmark('021')">021</a></li>
        <li> <a href="#" onclick="renderBenchmark('022')">022</a></li>
        <li> <a href="#" onclick="renderBenchmark('023')">023</a></li>
        <li> <a href="#" onclick="renderBenchmark('024')">024</a></li>
        <li> <a href="#" onclick="renderBenchmark('025')">025</a></li>
        <li> <a href="#" onclick="renderBenchmark('026')">026</a></li>
        <li> <a href="#" onclick="renderBenchmark('027')">027</a></li>
        <li> <a href="#" onclick="renderBenchmark('028')">028</a></li>
        <li> <a href="#" onclick="renderBenchmark('029')">029</a></li>
        <li> <a href="#" onclick="renderBenchmark('030')">030</a></li>
        <li> <a href="#" onclick="renderBenchmark('031')">031</a></li>
        <li> <a href="#" onclick="renderBenchmark('032')">032</a></li>
        <li> <a href="#" onclick="renderBenchmark('033')">033</a></li>
        <li> <a href="#" onclick="renderBenchmark('034')">034</a></li>
        <li> <a href="#" onclick="renderBenchmark('035')">035</a></li>
        <li> <a href="#" onclick="renderBenchmark('036')">036</a></li>
        <li> <a href="#" onclick="renderBenchmark('037')">037</a></li>
        <li> <a href="#" onclick="renderBenchmark('038')">038</a></li>
        <li> <a href="#" onclick="renderBenchmark('039')">039</a></li>
        <li> <a href="#" onclick="renderBenchmark('040')">040</a></li>
        <li> <a href="#" onclick="renderBenchmark('041')">041</a></li>
        <li> <a href="#" onclick="renderBenchmark('042')">042</a></li>
        <li> <a href="#" onclick="renderBenchmark('043')">043</a></li>
        <li> <a href="#" onclick="renderBenchmark('044')">044</a></li>
        <li> <a href="#" onclick="renderBenchmark('045')">045</a></li>
        <li> <a href="#" onclick="renderBenchmark('046')">046</a></li>
        <li> <a href="#" onclick="renderBenchmark('047')">047</a></li>
        <li> <a href="#" onclick="renderBenchmark('048')">048</a></li>
        <li> <a href="#" onclick="renderBenchmark('049')">049</a></li>
        <li> <a href="#" onclick="renderBenchmark('050')">050</a></li>
        <li> <a href="#" onclick="renderBenchmark('051')">051</a></li>
        <li> <a href="#" onclick="renderBenchmark('052')">052</a></li>
        <li> <a href="#" onclick="renderBenchmark('053')">053</a></li>
        <li> <a href="#" onclick="renderBenchmark('054')">054</a></li>
        <li> <a href="#" onclick="renderBenchmark('055')">055</a></li>
        <li> <a href="#" onclick="renderBenchmark('056')">056</a></li>
        <li> <a href="#" onclick="renderBenchmark('057')">057</a></li>
        <li> <a href="#" onclick="renderBenchmark('058')">058</a></li>
        <li> <a href="#" onclick="renderBenchmark('059')">059</a></li>
        <li> <a href="#" onclick="renderBenchmark('060')">060</a></li>
        <li> <a href="#" onclick="renderBenchmark('061')">061</a></li>
        <li> <a href="#" onclick="renderBenchmark('062')">062</a></li>
        <li> <a href="#" onclick="renderBenchmark('063')">063</a></li>
        <li> <a href="#" onclick="renderBenchmark('064')">064</a></li>
        <li> <a href="#" onclick="renderBenchmark('065')">065</a></li>
        <li> <a href="#" onclick="renderBenchmark('066')">066</a></li>
        <li> <a href="#" onclick="renderBenchmark('067')">067</a></li>
        <li> <a href="#" onclick="renderBenchmark('068')">068</a></li>
        <li> <a href="#" onclick="renderBenchmark('069')">069</a></li>
        <li> <a href="#" onclick="renderBenchmark('070')">070</a></li>
        <li> <a href="#" onclick="renderBenchmark('071')">071</a></li>
        <li> <a href="#" onclick="renderBenchmark('072')">072</a></li>
        <li> <a href="#" onclick="renderBenchmark('073')">073</a></li>
        <li> <a href="#" onclick="renderBenchmark('074')">074</a></li>
        <li> <a href="#" onclick="renderBenchmark('075')">075</a></li>
        <li> <a href="#" onclick="renderBenchmark('076')">076</a></li>
        <li> <a href="#" onclick="renderBenchmark('077')">077</a></li>
        <li> <a href="#" onclick="renderBenchmark('078')">078</a></li>
        <li> <a href="#" onclick="renderBenchmark('079')">079</a></li>
        <li> <a href="#" onclick="renderBenchmark('080')">080</a></li>
        <li> <a href="#" onclick="renderBenchmark('081')">081</a></li>
        <li> <a href="#" onclick="renderBenchmark('082')">082</a></li>
        <li> <a href="#" onclick="renderBenchmark('083')">083</a></li>
      </ul>
    </nav>

    <!-- Page Content -->
    <div id="content">
      <div id="front-page">
        <h1>Automated Visualization (AutoVis) Benchmarks</h1>
        <p>In AutoVis benchmarks, each visual sketch comes with an input data. <span style="font-weight: bold">Given the <span style="text-decoration: underline;">input data</span> and the <span style="text-decoration: underline;">visual sketch</span>, the goal is to create a <span style="text-decoration: underline;">visualization of the input data</span> such that all visual traces in the sketch are contained by the output visualization.</span> 

        <p>The dataset contains 83 benchmarks. Visual traces are described in the following format:</p>
        <code style="font-size:16px;">trace_type(...,attr=value,...)</code>
        <p>The grammar of traces is shown below, where <code>trace_type</code> is one of <code>bar</code>, <code>line</code>, <code>point</code>, <code>area</code>, and <code>attr</code> is one of <code>x</code>, <code>x2</code>, <code>y</code>, <code>y2</code>, <code>color</code>, <code>size</code>, <code>shape</code>, <code>column</code>, <code>row</code>, <code>width</code>, and <code>x_top_left</code>, <code>y_top_left</code>, <code>x_top_right</code>, <code>y_bot_right</code>, <code>x_bot_left</code>, <code>y_bot_left</code>, <code>x_bot_right</code>, <code>y_bot_right</code> (for <code>area</code> types). Values in a visual trace can be a string, a number, a date, or a bool value.</p>

        <p style="margin: auto; width: inherit;"><pre style="display: inline-block; text-align: left;">
     trace  :=  trace_type(...,attr=value,...)
trace_type  :=  bar, line, point, area
      attr  :=  x, x2, y, y2, color, size, shape, column, row, width, 
             |  x_top_lefty_top_left, x_top_right, y_bot_right, 
             |  x_bot_left, y_bot_left, x_bot_right, y_bot_right
     value  :=  string, number, date, bool
</pre></p>

        <p>Target visualizations include bar charts, line charts, scatter plots, area charts, stacked bar (area) charts, multi-layered charts, and facted (multi-vew) charts. Target visualizations and visual sketches are rendered using <a href='https://vega.github.io/vega-lite/'>Vega-Lite</a> with the help of <a href="https://github.com/vega/vega-embed">Vega-Embed</a> library. Besides providing rendered visualizations, we also provide visual traces (for both visual sketch and the target visualization) in textual form for reference.</p> 

        <p style="font-size: 14px">Note: Our visual representation of the visual sketch uses axis and labels from the full visualization to make the comparison between the visual sketch and the output visualization easy. In the synthesis task, these label/axis information are unknown to the synthesizer -- the synthesizer only gets information from the textual representation of the visualization (as traces).</p>

        <p style="font-size: 14px">Known issue: the visualization for benchmark 008 cannot be correctly rendered by Vega-Embed due to a bug in Vega-Embed library, thus we only present textual representation of the visualizations for this benchmark.</p> 
      </div>
      <div id="benchmark-page">
        <h1 id="benchmark-header"> </h1>
        <div class="container">
          <div>
            <h4>Input Data</h4>
            <div id="input-table">
              <table id="input-data" data-page-size="15" data-toggle="table" 
                data-pagination="true" data-pagination-loop="false"
                data-pagination-h-align="left" data-pagination-detail-h-align="right"
                class="table-sm table-bordered table-hover table-striped"></table>
            </div>
          </div>
          <h4>Visual Sketch</h4>
          <div class="trace-container">
            <div id="example-trace-vis"></div>
            <div id="example-trace-text"></div>
          </div>
          <h4>Target Visualization</h4>
          <div class="trace-container">
            <div id="full-vis"></div>
            <div id="full-trace-text"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    renderHome();

    function renderHome() {
      $("#front-page").css("display", "block");
      $("#benchmark-page").css("display", "none");
    }

    function renderBenchmark(idStr) {

      $("#front-page").css("display", "none");
      $("#benchmark-page").css("display", "block");

      const id = parseInt(idStr) - 1;

      $("#benchmark-header").text("Benchmark " + (id + 1));

      // get vis spec
      var spec = benchmarks[id]["vl_spec"];
      var traceVisSpec = JSON.parse(JSON.stringify(spec));

      // show input data
      const columns = []
      const keys = Object.keys(benchmarks[id]["input_data"][0]);
      for (var k in keys) {
        columns.push({field: keys[k], title: keys[k]});
      }

      $table = $('#input-data')
      $table.bootstrapTable('destroy')
      $table.bootstrapTable({
        columns: columns,
        data: benchmarks[id]["input_data"]
      });

      // prepare trace data that will be used in visualization
      var traceVisData = [];
      var containsX2 = false;
      var containsY2 = false;

      for (var k in benchmarks[id]["sample_trace"]) {
        const trace = benchmarks[id]["sample_trace"][k];
        var traceCopy = JSON.parse(JSON.stringify(trace["props"]));
        traceCopy["layer_id"] = trace["type"];
        traceVisData.push(traceCopy);
        if ("x2" in traceCopy) {
          containsX2 = true
        }
        if ("y2" in traceCopy) {
          containsY2 = true
        }
      }

      // visualize trace
      if ("encoding" in traceVisSpec) {
        const mark =  (typeof traceVisSpec["mark"] === "string") ? traceVisSpec["mark"] : traceVisSpec["mark"]["type"];

        var isStackedChart = false
        if ((mark == "bar" || mark == "area") && "color" in traceVisSpec["encoding"]) {
          isStackedChart = true
        }

        var channelToField = {};
        for (var key in traceVisSpec["encoding"]) {
          channelToField[key] = traceVisSpec["encoding"][key]["field"];
        } 

        for (var key in traceVisSpec["encoding"]) {

          if (key == "x2" || key == "y2" || key == "column") {
            traceVisSpec["encoding"][key]["field"] = key; 
            continue;
          }

          if (key == "order") {
            for (var k2 in channelToField) {
              if (k2 != "order" && channelToField[k2] == channelToField["order"]) {
                traceVisSpec["encoding"][key]["field"] = key;
                break
              }
            }
            continue;
          }
      
          // infer domain of the field
          var domain = benchmarks[id]["output_data"].map(d => d[channelToField[key]])
          if (key == "x" && "x2" in traceVisSpec["encoding"]) {
            domain = domain.concat(benchmarks[id]["output_data"].map(d => d[traceVisSpec["encoding"]["x2"]["field"]]));
          }
          if (key == "y" && "y2" in traceVisSpec["encoding"]) {
            domain = domain.concat(benchmarks[id]["output_data"].map(d => d[traceVisSpec["encoding"]["y2"]["field"]]));
          }

          const encodingType =  traceVisSpec["encoding"][key]["type"];

          if (encodingType == "nominal" || encodingType == "ordinal") {
            domain.sort();
            traceVisSpec["encoding"][key]["scale"] = {"domain": [...new Set(domain)]}; 
          }
          if (encodingType == "quantitative" && !isStackedChart) {
            const maxVal = Math.max(...domain);
            const minVal = Math.min(...domain);
            traceVisSpec["encoding"][key]["scale"] = {"domain": [Math.min(0, minVal), maxVal]}; 
          }

          traceVisSpec["encoding"][key]["field"] = key; 
        }
        
        if (mark == "bar") {
          if (containsY2 && ! ("y2" in traceVisSpec["encoding"])) {
            traceVisSpec["encoding"]["y2"] = {"field": "y2"};
          }
          if (containsX2 && ! ("x2" in traceVisSpec["encoding"])) {
            traceVisSpec["encoding"]["x2"] = {"field": "x2"};
          }
        }
      } else {

        var containsStackedChart = false
        
        for (var k = 0; k < traceVisSpec["layer"].length; k ++) {
          var layer = traceVisSpec["layer"][k];
          const mark =  (typeof layer["mark"] === "string") ? layer["mark"] : layer["mark"]["type"];
          if ((mark == "bar" || mark == "area") && "color" in layer["encoding"]) {
            containsStackedChart = true
          }
        }

        for (var k = 0; k < traceVisSpec["layer"].length; k ++) {
          var layer = traceVisSpec["layer"][k];

          var channelToField = {};
          for (var key in layer["encoding"]) {
            channelToField[key] = layer["encoding"][key]["field"];
          } 

          for (var key in layer["encoding"]) {

            if (key == "x2" || key == "y2") {
              layer["encoding"][key]["field"] = key; 
              continue;
            }

            if (key == "order") {
              for (var k2 in channelToField) {
                if (k2 != "order" && channelToField[k2] == channelToField["order"]) {
                  layer["encoding"][key]["field"] = key;
                  break
                }
              }
              continue;
            }

            // infer domain of the field
            var domain = benchmarks[id]["output_data"].map(d => d[channelToField[key]])
            if (key == "x" && "x2" in layer["encoding"]) {
              domain = domain.concat(benchmarks[id]["output_data"].map(d => d[layer["encoding"]["x2"]["field"]]));
            }
            if (key == "y" && "y2" in layer["encoding"]) {
              domain = domain.concat(benchmarks[id]["output_data"].map(d => d[layer["encoding"]["y2"]["field"]]));
            }

            const encodingType =  layer["encoding"][key]["type"];

            if (encodingType == "nominal" || encodingType == "ordinal") {
              domain.sort();
              layer["encoding"][key]["scale"] = {"domain": [...new Set(domain)]}; 
            }
            if (encodingType == "quantitative" && !containsStackedChart) {
              const maxVal = Math.max(...domain);
              const minVal = Math.min(...domain);
              layer["encoding"][key]["scale"] = {"domain": [Math.min(0, minVal), maxVal]}; 
            }

            layer["encoding"][key]["field"] = key;
          }

          layerMark =  (typeof layer["mark"] === "string") ? layer["mark"] : layer["mark"]["type"];
          layer["transform"] = [{filter: "datum.layer_id == \"" + (layerMark == "circle" ? "point" : layerMark) + "\""}];

          if (layerMark == "bar") {
            if (containsY2 && ! ("y2" in layer["encoding"])) {
              layer["encoding"]["y2"] = {"field": "y2"};
            }
            if (containsX2 && ! ("x2" in layer["encoding"])) {
              layer["encoding"]["x2"] = {"field": "x2"};
            }
          }
        }
      }

      traceVisSpec["data"] = {"values": traceVisData};

      function processTrace(trace, addSep) {
        var spanList = [];
        for (var i = 0; i < trace.length; i ++) {
          var body = [];
          for (const key in trace[i]["props"]) {
            const val = trace[i]["props"][key];
            body.push("<span class='key'>" + key + "=" + "</span>"  + "<span class='value'>" + val + "</span>");
          }
          spanList.push("<span class='tr-element'><code class='tr-element'>" 
                        + trace[i]["type"] + "(" + body.join(", ") + ")" + "</code></span>");
          if (addSep)
            spanList.push("<span style='pre'>,  </span>")
        }
        return spanList;
      }
      
      //console.log(JSON.stringify(traceVisSpec));

      $("#example-trace-vis").empty()
      vegaEmbed("#example-trace-vis", traceVisSpec)
        .catch((err) => {
          $("#example-trace-vis").append("<span style='color:grey;margin-bottom:15px;'>[There is an issue rendering the visual trace due to VegaEmbed error. Visual trace will be displayed in textual form only.]<span>");
          console.warn(err);
        });
      $("#example-trace-text").empty();
      $("#example-trace-text").append(processTrace(benchmarks[id]["raw_sample_trace"], false));

      //console.log(JSON.stringify(traceVisSpec));
      // visualize full vis
      spec["data"] = {"values": benchmarks[id]["output_data"]};

      //console.log(JSON.stringify(spec));

      $("#full-vis").empty()
      vegaEmbed("#full-vis", spec)
        .catch(err => {
          $("#full-vis").append("<span style='color:grey;margin-bottom:15px;'>[There is an issue rendering the visual trace due to VegaEmbed error. Visual trace will be displayed in textual form only.]<span>");
          console.warn(err);
        });
        // result.view provides access to the Vega View API
        // .then(result => console.log(result.vgSpec.scales))
        // .catch(console.warn);
      $("#full-trace-text").empty();
      $("#full-trace-text").append(processTrace(benchmarks[id]["raw_full_trace"], true));
    }
    
  </script>
</body>